<!DOCTYPE html>
<html lang="cn">
<head>
    <meta charset="UTF-8">
    <title>远程鼠标键盘</title>
    <link rel="stylesheet" href="/static/base.css">
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <style>
        body {
            position: fixed;
            top: 0;
            left: 0;

        }
    </style>
</head>
<body>
<canvas id="canvas" style='background-color:#ccc;' width="375" height="600"></canvas>
<script type='text/javascript'>

    let conn;
    // keyPOS
    let keyPos = new Map;
    const canvasElem = document.getElementById('canvas');
    const ctx = canvasElem.getContext('2d');


    canvasElem.addEventListener('mousemove', procMove, false);
    canvasElem.addEventListener('mouseout', procOut, false);

    function procMove(e) {
        const x = e.clientX;
        const y = e.clientY;
        const node = e.target;
        console.log("Coordinates: (" + x + "," + y + ")");
        if (ctx.isPointInPath(x, y)) {
            document.body.style.cursor = "pointer";
        } else {
            document.body.style.cursor = "default";
        }
        const _x = e.offsetX === undefined ? e.layerX : e.offsetX;
        const _y = e.offsetY === undefined ? e.layerY : e.offsetY;
        ctx.fillRect(_x, _y, 3, 3);
    }

    function procOut() {
        document.body.style.cursor = "default";
    }


    // key
    function rectangle(x, y, w, h) {
        ctx.beginPath();
        ctx.rect(x, y, w, h);
        ctx.fillStyle = 'black';
        ctx.fill();
        ctx.lineWidth = 1;
        ctx.strokeStyle = 'black';
        ctx.stroke();
    }

    function text(t, x, y) {
        ctx.font = '30pt Calibri';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#ffffff';
        ctx.fillText(t, x, y);
    }

    function _drawKey(x, y, w, h, t, key) {
        rectangle(x, y, w, h)
        text(t, x + (w / 2), y + (h / 2))
        keyPos.set(key, {"x": x, "y": y, "w": w, "h": h});
    }


    const windowWidth = 375;
    const keyStart = 450;
    const span = 5;
    const w = 60;
    const h = 60;
    const x = (windowWidth / 2) - (w / 2);
    const y = keyStart;
    const y2 = y + h + span;

    function drawKey() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        _drawKey(x, y, w, h, '↑', 'top')
        _drawKey(x - w - span, y2, w, h, '←', 'left')
        _drawKey(x, y2, w, h, '↓', 'down')
        _drawKey(x + w + span, y2, w, h, '→', 'right')
    }

    drawKey();
    // key

    // key click event

    canvas.addEventListener('click', function (e) {

        p = getEventPosition(e);
        console.log(p)
        drawKey(p);

    }, false);

    function getEventPosition(ev) {

        let x, y;

        if (ev.layerX || ev.layerX === 0) {

            x = ev.layerX;

            y = ev.layerY;

        } else if (ev.offsetX || ev.offsetX === 0) { // Opera

            x = ev.offsetX;

            y = ev.offsetY;

        }

        return {x: x, y: y};

    }

    console.error(keyPos)
</script>
<script type="text/javascript">
    window.onload = function () {
        if (window["WebSocket"]) {
            conn = new WebSocket("ws://" + document.location.host + "/ws");
            conn.onclose = function (evt) {
                console.log('onclose');
            };
            conn.onmessage = function (evt) {
                let messages = evt.data.split('\n');
                for (let i = 0; i < messages.length; i++) {
                    console.log(messages[i]);
                }
            };
        }else{
            console.error("<b>Your browser does not support WebSockets.</b>")
        }
    };
</script>
</body>
</html>